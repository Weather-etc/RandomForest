# RandomForest: parallel edition
## 团队名称
SupremeDivine
## 项目简介
随机森林的C++实现使用了真实数据集来验证其准确性和有效性。详细算法请参考目录下"Report/REPORT.pdf"，或者Leo Breiman的“Random Forest”（2001）。
对于并行修订版，使用英特尔oneAPI工具集进行并行化。
## 算法简介
随机森林（Random Forest, RF）算法是一类集成学习算法，它由统计学习界的大师级人物 Leo Breiman(1928–2005) 提出。它是若干随机树（Randomized Tree）的组合，这些随机树彼此互相独立，而且在训练样本的选择和树的生长过程中引入随机性以降低树结构分类器较高的方差。随机森林在很多应用场景下具有不错的准确性。


它具备一些优良特性，比如，较少的超参，高效的训练与预测，多分类和对噪声不敏感等。这些特性使它广泛应用于不同领域，比如计算机视觉，遥感，生物信息学等。特别在计算机视觉领域，随机森林在图像分割、特征点识别、目标检测和人体部件识别等方面都有比较成功的应用。
### 随机树
RandomTree 以树的深度作为停止条件，按照 CART 内描述的方法递归地创建树形分类器的节点。


利用随机抽取和 criteria 选择特征然后分裂节点。具体地，每次分裂节点前，需要从给定的所有特征中不放回地抽取指定个数，然后根据评价函数集 F 中的函数来选择最优的作为当前节点的选定特征。
在不放回地抽取特征时，可以利用 KnuthDurstenfeld shuffle 算法来避免繁琐的元素插入/删除作。
### 随机森林
随机森林中包含有 n 个 随机树 ，这些随机树被放置在一个队列中。
在训练/预测时，通过 n 次出队、入队来实现对它们的遍历。投票时决定最终的输出时，将按照“少数服从多数的原则”，选择多数分类器的结果作为最终的结果。
### 商业价值
金融：由于其能够节省数据管理和预处理的时间，随机森林被大量运用于对高风险客户的欺诈预测。

健康管理：随机森林被用于计算生物学，帮助医生解决基因表现分类、生物标记物侦测、基因序列注释等

电子商务：随机森林可被用于推荐引擎的搭建。
## 实现方案
### VTune
VTune是英特尔开发的一款性能分析工具，旨在帮助开发人员优化其应用程序的性能。它主要用于分析和调优软件，以确保其在Intel处理器上运行时能够充分利用硬件资源，提高性能并降低功耗。VTune提供了广泛的性能分析功能，包括：


热点分析：帮助你找出代码中的瓶颈，以便优化性能。


内存分析：跟踪内存使用情况，包括泄漏和缓存访问。


多线程分析：帮助你发现多线程应用程序中的并发问题。


向量化分析：优化使用SIMD指令的代码以提高运行速度。


功耗分析：检测应用程序对处理器功耗的影响。


使用Vtune工具进行性能分析，可以找到程序性能的瓶颈处。本次项目中，VTune帮助我们成功发现了程序的性能瓶颈。我们在Hotspots模式下发现randomforest.cpp
中第77行的state.build()函数所占CPU Time较长，达到近90%
### openMP
OpenMP（Open Multi-Processing）是一种用于并行编程的API（应用程序编程接口），旨在帮助开发者利用多核处理器和共享内存系统的并行计算能力。它采用了一种基于共享内存的并行模型，允许在单个计算机上的多个处理核心之间共享数据和任务。


OpenMP设计的初衷是简化并行编程。它通过在现有的串行代码中插入特定的指令或注释，使得开发者能够轻松地创建并行程序，而无需大规模的代码重构。
程序员可以标记一段代码作为并行区域，然后OpenMP库将自动将该区域的工作分配给可用的处理器核心。这使得任务的并行化变得相对容易。
同时OpenMP还提供了一系列的编译指令和运行时库函数，用于控制并行区域的行为，如指定并行执行的线程数量、数据共享和同步操作。
良好的数据范围并行性使openMP允许不同线程并行处理不同的数据元素，例如循环迭代、数组元素等。


借助openMP，我们首先考虑进行state.build()函数间的并行。首先，我们重写了此函数，借助临时数组将队列操作转换为数组操作，以便使用openMP的多线程并行化。
并且我们将对共享变量的操作独立出来，减轻临界区的开销。由此，可以获得五倍左右的加速。

### Result
实验结果如图，加速效果达到预期。森林中包含300棵树时，具有三倍左右加速，包含600棵树时，加速效果接近5倍。
![result](https://github.com/Weather-etc/RandomForest/blob/oneAPI/imgs/img1.png)
![result](https://github.com/Weather-etc/RandomForest/blob/oneAPI/imgs/img2.png)


